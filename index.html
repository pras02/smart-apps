<!-- index.html -->

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://combinatronics.com/smart-on-fhir/client-js/master/dist/build/fhir-client.js"></script>
    <script src="https://combinatronics.com/smart-on-fhir/client-js/master/dist/build/fhir-client.min.js"></script>
    <title>Document</title>
</head>

<body>
    <div class="cell full">
        <h4>Patient Medications</h4>
        <pre id="output">Loading...</pre>
    </div>
    <script type="text/javascript">

        function createRenderer(id) {
            const output = id ? document.getElementById(id) : document.body;
            return function (data) {
                output.innerText = data && typeof data === "object"
                    ? JSON.stringify(data, null, 4)
                    : String(data);
            };
        }

        var render = createRenderer("output")
        
        FHIR.oauth2.ready()
            .then(function (client) {
                client.request("MedicationStatement?patient=19", {
                    resolveReferences: ["medicationReference"],
                    graph: true
                })
                    .then(function (data) {
                        if (!data.entry || !data.entry.length) {
                            throw new Error("No medications found for the selected patient");
                        }
                        return data.entry;
                    })
                    .then(function (entries) {
                        return entries.map(function (item) {
                            return getMedicationName(
                                client.getPath(item, "resource.medicationCodeableConcept.coding") ||
                                client.getPath(item, "resource.medicationReference.code.coding")
                            );
                        });
                    })
                    .then(render)
                    .then(console.log)
                    .catch(console.error)
            })
    </script>
</body>

</html>